Value â‡ {
  obj â† {
    this â‡ @
    SetThis â‡ { !thisâ‰¡@ â‹„ thisâ†©ğ•© }

    #O â† âŠ¢
    B â† âŠ¢
    c â† âŸ¨âŸ©
    d â† 0
    g â† 0
    l â† ""

    Show â‡ {ğ•¤
      #lab â† "label"â€¿"operation"â€¿"children"â€¿"data"â€¿"gradient"
      #â‰> lab â‹ˆ lâ€¿oâ€¿câ€¿dâ€¿g
      lab â† "label"â€¿"children"â€¿"data"â€¿"gradient"
      â‰> lab â‹ˆ lâ€¿câ€¿dâ€¿g
    }

    Data â‡ {
      ğ•¤ â‹„ d
    }

    Grad â‡ {
      ğ•¤ â‹„ g
    }

    Child â‡ {
      ğ•¤ â‹„ c
    }

    #Oper â‡ {
    #  ğ•¤ â‹„ o
    #}

    Label â‡ {
      ğ•¤ â‹„ l
    }

    Ba â‡ {
      B â†© ğ•
    }

    #Op â‡ {
    #  O â†© ğ•
    #}

    Ch â‡ {
      c â†© ğ•©
    }

    Gr â‡ {
      g â†© ğ•©
    }

    Da â‡ {
      d â†© ğ•©
    }

    La â‡ {
      l â†© ğ•©
    }

    Back â‡ {
      ğ•¤ â‹„ B@
    }

    Backward â‡ {ğ•¤
      v â† âŸ¨âŸ©

      TopoSort â† {
        oldV â† v
        TopoSortÂ¨ oldV (Â¬âˆ˜âˆŠ/âŠ£)Ëœ âˆ¾ { ğ•©.Child@ }Â¨ ğ•©
        v â†© â· ğ•© âˆ¾ v
        v
      }

      this.Gr 1
      { ğ•©.Back@ }Â¨ TopoSort this
      v
    }

    Apply â† {
      out â† Value ğ•Â´ { ğ•©.Data@ }Â¨ ğ•©
      #out.Op ğ•¨
      out.Ch ğ•©
      out
    }

    Tanh â‡ {ğ•¤
      F â† â€¢math.Tanh
      out â† Value F d
      #out.Op f
      out.Ch â‹ˆthis

      BB â† {ğ•¤
        g â†© g + (1 - 2 â‹†Ëœ out.Data@) Ã— out.Grad@
      }

      out.Ba bb
      out
    }

    Add â‡ {
      F â† +

      i â† ğ•©
      out â† f Apply thisâ€¿ğ•©

      BB â† {ğ•¤
        i.Gr (i.Grad@) + out.Grad@
        g â†© g + out.Grad@
      }

      out.Ba bb
      out
    }

    Mul â‡ {
      F â† Ã—

      i â† ğ•©
      out â† f Apply thisâ€¿ğ•©

      BB â† {ğ•¤
        i.Gr (i.Grad@) + d Ã— out.Grad@
        g â†© g + (i.Data@) Ã— out.Grad@
      }

      out.Ba bb
      out
    }

    Exp â‡ {ğ•¤
      F â† â‹†

      out â† Value F d
      #out.Op f
      out.Ch â‹ˆthis

      BB â† {ğ•¤
        g â†© g + (out.Data@) Ã— out.Grad@
      }

      out.Ba bb
      out
    }

    Pow â‡ {
      F â† â‹†âŸœğ•©
      i â† ğ•©
      out â† Value F d
      #out.Op f
      out.Ch â‹ˆthis


      BB â† {ğ•¤
        g â†© g + (i Ã— d â‹† 1 -Ëœ i) Ã— out.Grad@
      }

      out.Ba bb
      out
    }

    Neg â‡ {ğ•¤
      this.Mul Value Â¯1
    }

    Sub â‡ {
      this.Add ğ•©.Neg@
    }

    Div â‡ {
      this.Mul ğ•©.Pow Â¯1
    }
  }

  obj.SetThis obj
  obj.Da ğ•©
  obj
}

TanhF â† âŠ‘ â€¢math.Tanh
AddF â† +Â´
MulF â† Ã—Â´
PowF â† â‹†Â´
ExpF â† âŠ‘ â‹†

TanhB â† {
  oâ€¿c â† ğ•¨
  g â† (âŠ¢Ã—1-2â‹†ËœâŠ£)Â´ 2 â†‘ o âŠ ğ•©
  gâŠ¸+âŒ¾(1âŠ¸âŠË˜câŠ¸âŠ) ğ•©
}

AddB â† {
  oâ€¿c â† ğ•¨
  g â† 1 âŠ‘ o âŠ ğ•©
  gâŠ¸+âŒ¾(1âŠ¸âŠË˜câŠ¸âŠ) ğ•©
}

MulB â† {
  oâ€¿c â† ğ•¨
  g â† 1 âŠ‘ o âŠ ğ•©
  gs â† +âŸœ(âŒ½ gâŠ¸Ã—)Â´ <Ë˜ â‰ 1â€¿0âŠ¸âŠË˜ c âŠ ğ•©
  gsâŒ¾(1âŠ¸âŠË˜câŠ¸âŠ) ğ•© # needs further refactoring
}

PowB â† {
  oâ€¿c â† ğ•¨
  g â† 1 âŠ‘ o âŠ ğ•©
  dâ€¿i â† âŠ‘Ë˜ c âŠ ğ•©
  { ğ•© + g Ã— i Ã— d â‹† 1 -Ëœ i }âŒ¾(1âŠ¸âŠÂ·0âŠ¸âŠ câŠ¸âŠ) ğ•©
}

ExpB â† {
  oâ€¿c â† ğ•¨
  g â† Ã—Â´ 2 â†‘ o âŠ ğ•©
  gâŠ¸+âŒ¾(1âŠ¸âŠË˜câŠ¸âŠ) ğ•©
}

ops â† âŠ¢â€¿AddFâ€¿MulFâ€¿PowFâ€¿ExpFâ€¿TanhF
bops â† âŠ¢â€¿AddBâ€¿MulBâ€¿PowBâ€¿ExpBâ€¿TanhB

_a â† {
  ch â† â¥Šğ•©
  vv â† ğ”½ âŠ‘Ë˜ ch âŠ ğ•¨
  op â† âŠ‘ / ğ•— = ops
  ğ•¨ âˆ¾ â‰ vvâ€¿0â€¿opâ€¿ch
}

Addâ€¿Mulâ€¿Expâ€¿Powâ€¿Tanh â‡ (AddF _a)â€¿(MulF _a)â€¿(ExpF _a)â€¿(PowF _a)â€¿(TanhF _a)

V â‡ { â‰ ğ•©â€¿0â€¿0â€¿âŸ¨âŸ© }
Val â‡ âˆ¾âŸœV

Neg â‡ {
  (ğ•¨ Val Â¯1) Mul ğ•©â‹ˆâ‰ ğ•¨
}

Sub â‡ {
  aâ€¿b â† ğ•©
  (ğ•¨ Neg b) Add aâ‹ˆ1+â‰ ğ•¨
}

Div â‡ {
  aâ€¿b â† ğ•©
  ((ğ•¨ Val Â¯1) Pow bâ‹ˆâ‰ ğ•¨) Mul aâ‹ˆ1+â‰ ğ•¨
}

Topo â† {
  ğ•© âˆ¾ âˆ¾ ğ•¨ Topoâš‡2â€¿0 Â¯1 âŠ‘ ğ•© âŠ ğ•¨
}

BackProp â† {
  vv â† ğ•¨ âŠ ğ•©
  back â† bops âŠ‘Ëœ 2 âŠ‘ vv
  ğ•© BackËœ ğ•¨ â‹ˆ 3 âŠ‘ vv
}

Backward â‡ {
  t â† ğ•¨ Topo ğ•©
  i â† âŠ‘ t
  w â† 1âŒ¾(1âŠ¸âŠ‘ iâŠ¸âŠ) ğ•¨

  w BackPropÂ´ âŒ½ t
}
