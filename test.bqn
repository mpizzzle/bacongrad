#âŸ¨ValueâŸ© â† â€¢Import "value.bqn"
âŸ¨V, Val, Add, Mul, Exp, Pow, Tanh, Neg, Sub, Div, BackwardâŸ© â† â€¢Import "value.bqn"

#TanhF â† âŠ‘ â€¢math.Tanh
#AddF â† +Â´
#MulF â† Ã—Â´
#PowF â† â‹†Â´
#ExpF â† âŠ‘ â‹†
#
#TanhB â† {
#  oâ€¿c â† ğ•¨
#  g â† (âŠ¢Ã—1-2â‹†ËœâŠ£)Â´ 2 â†‘ o âŠ ğ•©
#  gâŠ¸+âŒ¾(1âŠ¸âŠË˜câŠ¸âŠ) ğ•©
#}
#
#AddB â† {
#  oâ€¿c â† ğ•¨
#  g â† 1 âŠ‘ o âŠ ğ•©
#  gâŠ¸+âŒ¾(1âŠ¸âŠË˜câŠ¸âŠ) ğ•©
#}
#
#MulB â† {
#  oâ€¿c â† ğ•¨
#  g â† 1 âŠ‘ o âŠ ğ•©
#  gs â† +âŸœ(âŒ½ gâŠ¸Ã—)Â´ <Ë˜ â‰ 1â€¿0âŠ¸âŠË˜ c âŠ ğ•©
#  gsâŒ¾(1âŠ¸âŠË˜câŠ¸âŠ) ğ•© # needs further refactoring
#}
#
#PowB â† {
#  oâ€¿c â† ğ•¨
#  g â† 1 âŠ‘ o âŠ ğ•©
#  dâ€¿i â† âŠ‘Ë˜ c âŠ ğ•©
#  { ğ•© + g Ã— i Ã— d â‹† 1 -Ëœ i }âŒ¾(1âŠ¸âŠÂ·0âŠ¸âŠ câŠ¸âŠ) ğ•©
#}
#
#ExpB â† {
#  oâ€¿c â† ğ•¨
#  g â† Ã—Â´ 2 â†‘ o âŠ ğ•©
#  gâŠ¸+âŒ¾(1âŠ¸âŠË˜câŠ¸âŠ) ğ•©
#}
#
#ops â† âŠ¢â€¿AddFâ€¿MulFâ€¿PowFâ€¿ExpFâ€¿TanhF
#bops â† âŠ¢â€¿AddBâ€¿MulBâ€¿PowBâ€¿ExpBâ€¿TanhB
#
#_a â† {
#  ch â† â¥Šğ•©
#  vv â† ğ”½ âŠ‘Ë˜ ch âŠ ğ•¨
#  op â† âŠ‘ / ğ•— = ops
#  ğ•¨ âˆ¾ â‰ vvâ€¿0â€¿opâ€¿ch
#}
#
#Addâ€¿Mulâ€¿Expâ€¿Powâ€¿Tanh â† (AddF _a)â€¿(MulF _a)â€¿(ExpF _a)â€¿(PowF _a)â€¿(TanhF _a)
#
#V â† { â‰ ğ•©â€¿0â€¿0â€¿âŸ¨âŸ© }
#Val â† âˆ¾âŸœV
#
#Neg â† {
#  (ğ•¨ Val Â¯1) Mul ğ•©â‹ˆâ‰ ğ•¨
#}
#
#Sub â† {
#  aâ€¿b â† ğ•©
#  (ğ•¨ Neg b) Add aâ‹ˆ1+â‰ ğ•¨
#}
#
#Div â† {
#  aâ€¿b â† ğ•©
#  ((ğ•¨ Val Â¯1) Pow bâ‹ˆâ‰ ğ•¨) Mul aâ‹ˆ1+â‰ ğ•¨
#}
#
#Topo â† {
#  ğ•© âˆ¾ âˆ¾ ğ•¨ Topoâš‡2â€¿0 Â¯1 âŠ‘ ğ•© âŠ ğ•¨
#}
#
#BackProp â† {
#  vv â† ğ•¨ âŠ ğ•©
#  back â† bops âŠ‘Ëœ 2 âŠ‘ vv
#  ğ•© BackËœ ğ•¨ â‹ˆ 3 âŠ‘ vv
#}
#
#Backward â† {
#  t â† ğ•¨ Topo ğ•©
#  i â† âŠ‘ t
#  w â† 1âŒ¾(1âŠ¸âŠ‘ iâŠ¸âŠ) ğ•¨
#
#  w BackPropÂ´ âŒ½ t
#}

mat â† V 2
mat Valâ†© 0
mat Valâ†© Â¯3
mat Valâ†© 1
mat Mulâ†© 0â€¿2
mat Mulâ†© 1â€¿3
mat Addâ†© 4â€¿5
mat Valâ†© 6.8813735870195432
mat Addâ†© 6â€¿7

#mat Tanhâ†© 8
#mat Backward 9

mat Valâ†© 2
mat Mulâ†© 8â€¿9
mat Expâ†© 10
mat Valâ†© 1
mat Subâ†© 11â€¿12
mat Valâ†© 1
mat Addâ†© 11â€¿16
mat Divâ†© 15â€¿17
mat Backward 20

#x1 â† Value 2.0
#x2 â† Value 0.0
#w1 â† Value Â¯3.0
#w2 â† Value 1.0
#
#x1w1 â† x1.Mul w1
#x2w2 â† x2.Mul w2
#
#x1w1x2w2 â† x1w1.Add x2w2
#
#b â† Value 6.8813735870195432
#
#n â† x1w1x2w2.Add b
#
##o â† n.Tanh@
#e â† (n.Mul Value 2).Exp@
#o â† (e.Sub Value 1).Div (e.Add Value 1)
#
#o.Backward@
#
#!Â¯1.5 â‰¡ x1.Grad@
#!0.5 â‰¡ x2.Grad@
#!1 â‰¡ w1.Grad@
#!0 â‰¡ w2.Grad@
