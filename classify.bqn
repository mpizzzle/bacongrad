âŸ¨ValueâŸ© â† â€¢Import "value_old.bqn"
âŸ¨Init, Val, Add, Sub, Mul, Pow, Tanh, BackwardâŸ© â† â€¢Import "value.bqn"
âŸ¨MLPâŸ© â† â€¢Import "nn_old.bqn"

Rand â† (1 -Ëœ 2 Ã— â€¢rand.RangeâŠ¸Ã·) 1 -Ëœ 2 â‹† 32Ë™

Neuron â† âŠ¢ (âŠ¢ Val Rand)Â´ Â·â†• 1 + âŠ£
Layer â† âŠ¢ NeuronÂ´ Â·/âŸœâ‹ˆÂ´âˆ˜âŒ½ âŠ£
MLPP â† 1âŠ¸â†“ (Init @) LayerÂ´ Â·<Ë˜âˆ˜âŒ½ 2âŠ¸â†•

Group â† âŒŠâˆ˜Ã·ËœâŸœ(â†•â‰ )âŠ”âŠ¢
Offset â† Â¯1 â†“ +Â´Â¨âˆ˜â†‘
Ranges â† 1â€¿0 +â‰1 2âŠ¸â†•
#Params â† +Â´ Â·Ã—Â´Ë˜ Ranges

Ind â† â‰ âŠ¸+âŸœâ†•-âŠ¢

CallLayer â† {
  mat â† ğ•¨
  inâ€¿out â† ğ•©
  sinâ€¿sout â† in â‹ˆâ—‹â‰  out
  weightsâ€¿biases â† sin (âˆ¾Â¨ â†‘Â¨ â‹ˆ Â¯1âŠ¸â†‘Â¨) out

  mat MulËœÂ´â†© âŒ½ weights â‰Â¨Ëœ âˆ¾ sout / â‹ˆ in
  mat AddËœÂ´â†© âŒ½ biases âˆ¾Â¨ sin Group mat Ind sin Ã— sout
  mat TanhËœÂ´â†© âŒ½ mat Ind sout
}

Expand â† {
  oâ€¿râ€¿g â† ğ•©
  o + g Group â†• r
}

Call â† {
  shaâ€¿ord â† ğ•¨
  ğ•© CallLayer (ğ•© Ind sha) â‹ˆ âˆ¾Â¨ <Ë˜ Expand ord
}

shape â† 3â€¿4â€¿4â€¿1
input â† âŸ¨2,3,Â¯1âŸ©â€¿âŸ¨3,Â¯1,0.5âŸ©â€¿âŸ¨0.5,1,1âŸ©â€¿âŸ¨1,1,Â¯1âŸ©
truth â† 1â€¿Â¯1â€¿Â¯1â€¿1

order â† â‰ (Â¯1âŠ¸â†“ (OffsetâŠ¸â‰ Ã—Â´Ë˜) âˆ¾ â‰) Ranges shape
so â† <Ë˜ (Â¯1 â†“ shape) âŠ‘âŠ¸â‹ˆË˜ order

CallEach â† {
  mat â† ğ•©
  mat ValËœÂ´â†© âŒ½ ğ•¨
  mat CallÂ´ âŒ½ so
}

F â† {
  dâ€¿gâ€¿oâ€¿c â† ğ•©
  (d + Â¯0.2Ã—g)â€¿gâ€¿oâ€¿c
}

ZG â† 0Â¨âŒ¾(1âŠ¸âŠË˜)

mm â† MLPP shape
offsets â† 1 -Ëœ 41 + (1+â†•4) Ã— 4 Ã·Ëœ 41 -Ëœ 253
p â† â‰  mm

Desc â†{ ğ•¤
  mm â†© FË˜ pâŠ¸â†‘ mm

  mm CallEachÂ´â†© âŒ½ input

  â€¢Show âŠ‘Ë˜ offsets âŠ mm

  mm ValËœÂ´â†© âŒ½ truth
  mm SubËœÂ´â†© âŒ½ offsets â‹ˆÂ¨ mm Ind 4

  subs â† (/0=3|1+â†•12) âŠ mm Ind 12

  mm ValËœÂ´â†© 4/â‰2
  mm PowËœÂ´â†© âŒ½ subs â‹ˆÂ¨ mm Ind 4
  mm Addâ†© âŒ½ mm Ind 4

  mm â†© ZG mm
  mm Backwardâ†© 1 -Ëœ â‰ mm
}

DescâŸ20 @

#m â† MLP shape
#xs â† Valueâš‡0 input
#ys â† ValueÂ¨ truth
#yp â† m.CallÂ¨ xs
#loss â† @
#
#Descent â† {ğ•¤
#  yp â†© m.CallÂ¨ xs
#  loss â†© { ğ•¨.Add ğ•© }Â´ yp { (ğ•¨.Sub ğ•©).Pow 2 }Â¨ ys
#
#  { ğ•©.Gr 0 }Â¨ m.Params@
#  loss.Backward@
#
#  { ğ•©.Da (ğ•©.Data@) + Â¯0.2 Ã— ğ•©.Grad@ }Â¨ m.Params@
#}
#
#â€¢Out "ground truth:"
#â€¢Show { ğ•©.Data@ }Â¨ ys
#â€¢Out "initial classification:"
#â€¢Show { ğ•©.Data@ }Â¨ yp
#DescentâŸ20 @
#â€¢Out "after training:"
#â€¢Show { ğ•©.Data@ }Â¨ yp
