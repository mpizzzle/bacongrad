âŸ¨Init, Val, Add, Sub, Mul, Pow, Tanh, BackwardâŸ© â† â€¢Import "value.bqn"
âŸ¨Rand, Group, Last, _lâŸ© â† â€¢Import "util.bqn"

Layer â† {
  in â† (m â† ğ•¨) Last 1 -Ëœ â‰  âŠ‘ out â† ğ•©
  weightsâ€¿biases â† in â‰ âŠ¸(âˆ¾Â¨ â†‘Â¨ â‹ˆ Â¯1âŠ¸â†‘Â¨) out

  m Mul _lâ†© weights â‰Â¨Ëœ âˆ¾ out â‰ âŠ¸/ â‹ˆ in
  m Add _lâ†© biases âˆ¾Â¨ in (âŠ£ Group m Last Ã—)â—‹â‰  out
  m Tanh _l m Last â‰ out
}

shape â† 3â€¿4â€¿4â€¿1
input â† âŸ¨2,3,Â¯1âŸ©â€¿âŸ¨3,Â¯1,0.5âŸ©â€¿âŸ¨0.5,1,1âŸ©â€¿âŸ¨1,1,Â¯1âŸ©
truth â† 1â€¿Â¯1â€¿Â¯1â€¿1
ranges â† Ã—Â´Ë˜ 1â€¿0 +â‰1 2âŠ¸â†• shape
params â† ranges GroupÂ¨âŸœ(â†•Â¨++`âŠ¸-)Ëœ 1 + Â¯1 â†“ shape
mlp â† âˆ¾ Initâˆ˜RandÂ¨ â†• p â† +Â´ ranges
offsets â† 93â€¿146â€¿199â€¿252 #???

Call â† Val _l Layer _l paramsË™

Loss â† {
  m â† ğ•© Val _l truth
  m Sub _lâ†© offsets â‹ˆÂ¨ m Last si â† â‰ input
  m Val _lâ†© si/â‰2
  m Pow _lâ†© (si -Ëœ 2â€¿5â€¿8â€¿11 âŠ m Last 3 Ã— si) â‹ˆÂ¨ m Last si #???
  m Add âŒ½ m Last si
}

Descent â† {
  m â† (pâ†‘ğ•©) Call _l input
  m â†© Loss m
  m â†© 0Ë˜âŒ¾(1âŠ¸âŠË˜) m
  m Backwardâ†© 1 -Ëœ â‰ m
  (âŠ¢â‹ˆËœâŠ£+Â¯0.2âŠ¸Ã—)Â´Ë˜âŒ¾(2âŠ¸â†‘Ë˜pâŠ¸â†‘) m
}

â€¢Out "ground truth:"
â€¢Show truth
â€¢Out "initial classification:"
â€¢Show âŠ‘Ë˜ offsets âŠ mlp Call _l input
â€¢Out "after training:"
â€¢Show âŠ‘Ë˜ offsets âŠ DescentâŸ20 mlp
